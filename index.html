<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ayuntamiento de Orea ¬∑ Estudio de Vivienda</title>
  <meta name="description" content="Web oficial del Ayuntamiento de Orea para participar en el estudio municipal sobre vivienda: oferta, demanda, disponibilidad y propuestas." />

  <!-- Escudo (SVG): https://upload.wikimedia.org/wikipedia/commons/1/10/Escudo_de_Orea.svg -->

  <style>
    :root{
      /* Colores inspirados en la her√°ldica del escudo: oro, sable, azur, plata, sinople */
      --gold:#D4AF37;
      --black:#111111;
      --blue:#1F6FEB;
      --green:#2EA043;
      --bg:#ffffff;
      --muted:#6b7280;
      --line:#e5e7eb;
      --shadow:0 10px 24px rgba(0,0,0,.08);
      --radius:14px;
    }

    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--black);background:var(--bg);line-height:1.55}
    a{color:var(--blue);text-decoration:none}
    a:hover{text-decoration:underline}
    .container{max-width:980px;margin:0 auto;padding:18px}

    header{position:sticky;top:0;z-index:20;background:#fff;border-bottom:1px solid var(--line)}
    .nav{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 0}

    .brand{display:flex;align-items:center;gap:12px;min-width:240px}
    .crest{width:38px;height:38px;border-radius:10px;border:1px solid var(--line);background:#fff;overflow:hidden;display:grid;place-items:center}
    .crest img{width:34px;height:34px;object-fit:contain}
    .brand h1{font-size:14px;margin:0}
    .brand p{font-size:12px;margin:0;color:var(--muted)}

    nav ul{list-style:none;margin:0;padding:0;display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    nav a{font-size:13px;color:var(--black);padding:8px 10px;border-radius:10px}
    nav a:hover{background:#f8fafc}

    .hero{padding:18px 0 6px}
    .card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
    .pad{padding:16px}

    .badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:rgba(212,175,55,.14);border:1px solid rgba(212,175,55,.35);font-size:12px}

    h2{margin:10px 0 8px;font-size:28px;line-height:1.2}
    p{margin:0 0 10px}
    .muted{color:var(--muted)}

    .cta{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn{appearance:none;border:1px solid var(--line);background:#fff;color:var(--black);padding:10px 12px;border-radius:12px;font-weight:700;font-size:14px;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
    .btn:hover{background:#f8fafc}
    .btnPrimary{border-color:rgba(31,111,235,.25);background:rgba(31,111,235,.06)}
    .btnDanger{border-color:rgba(220,38,38,.25);background:rgba(220,38,38,.06)}

    .section{margin-top:14px}
    .section h3{margin:0 0 10px;font-size:18px}

    form{display:flex;flex-direction:column;gap:12px}
    fieldset{border:1px solid var(--line);border-radius:14px;padding:14px}
    legend{padding:0 8px;font-weight:800}

    label{display:block;font-size:13px;margin-bottom:6px}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;color:var(--black);outline:none}
    input:focus,select:focus,textarea:focus{border-color:rgba(31,111,235,.55);box-shadow:0 0 0 3px rgba(31,111,235,.12)}
    textarea{min-height:110px;resize:vertical}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}

    .check{display:flex;gap:10px;align-items:flex-start;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff}
    .check input{width:auto;margin-top:3px}
    .check p{margin:0;color:var(--muted);font-size:12px}

    .msg{display:none;padding:12px;border-radius:12px;border:1px solid var(--line);background:#fff}
    .msg.ok{border-color:rgba(46,160,67,.30);background:rgba(46,160,67,.06)}
    .msg.err{border-color:rgba(220,38,38,.30);background:rgba(220,38,38,.06)}

    .divider{height:1px;background:var(--line);margin:12px 0}

    .propList{display:flex;flex-direction:column;gap:12px}
    .propItem{border:1px solid var(--line);border-radius:14px;padding:12px}
    .propHead{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
    .propHead b{font-size:14px}

    footer{border-top:1px solid var(--line);padding:16px 0;color:var(--muted);font-size:12px;margin-top:22px}

    @media (max-width:860px){
      .row{grid-template-columns:1fr}
      .brand{min-width:auto}
    }
  </style>
</head>
<body>

<header>
  <div class="container">
    <div class="nav">
      <div class="brand" aria-label="Identidad">
        <div class="crest" aria-hidden="true">
          <img alt="Escudo de Orea" src="https://upload.wikimedia.org/wikipedia/commons/1/10/Escudo_de_Orea.svg" />
        </div>
        <div>
          <h1>Ayuntamiento de Orea</h1>
          <p>Estudio municipal de vivienda</p>
        </div>
      </div>

      <nav aria-label="Navegaci√≥n principal">
        <ul>
          <li><a href="#objetivo">Objetivo</a></li>
          <li><a href="#encuesta">Encuesta</a></li>
          <li><a href="#privacidad">Privacidad</a></li>
          <li><a href="#rgpd">RGPD</a></li>
          <li><a href="#contacto">Contacto</a></li>
        </ul>
      </nav>
    </div>
  </div>
</header>

<div class="container hero" id="inicio">
  <section class="card pad" aria-label="Portada">
    <div class="badge" role="note">üè† Participaci√≥n abierta ¬∑ 7‚Äì10 minutos ¬∑ Recogida hasta el 31 de enero de 2026</div>
    <h2>Estudio sobre la vivienda en Orea</h2>
    <p class="muted">
      Esta web existe <b>solo</b> para recoger informaci√≥n sobre vivienda y otros inmuebles en Orea (oferta y demanda) y poder planificar medidas municipales.
      Si eres propietario/a (de una o varias viviendas, naves, negocios o parcelas) o quieres comprar o alquilar, tu respuesta es clave.
    </p>

    <div class="cta">
      <a class="btn btnPrimary" href="#encuesta">‚ñ∂ Empezar la encuesta</a>
      <button class="btn" type="button" id="btnEnviar">‚úâÔ∏è Enviar por email</button>
      <button class="btn" type="button" id="btnDescargar">‚¨áÔ∏è Descargar copia (JSON)</button>
    </div>

    <p class="hint">
      Al guardar, tus respuestas se almacenan tambi√©n en este dispositivo. Para que el estudio reciba los datos,
      pulsa ‚ÄúEnviar por email‚Äù para abrir un borrador dirigido a <b>rcalvo.orea@gmail.com</b>.
      Si has a√±adido muchos inmuebles, puede ser mejor descargar el JSON y adjuntarlo en el email.
    </p>
  </section>
</div>

<main class="container">

  <section id="objetivo" class="section">
    <div class="card pad">
      <h3>Objetivo del estudio</h3>
      <p class="muted">
        Conocer con precisi√≥n el parque de vivienda y otros inmuebles en Orea (viviendas, naves, negocios/locales y parcelas),
        as√≠ como la demanda de compra y alquiler, y facilitar la conexi√≥n entre personas ofertantes y demandantes,
        con el fin de dise√±ar actuaciones realistas en materia de vivienda.
      </p>
    </div>
  </section>

  <section id="beneficios" class="section">
    <div class="card pad">
      <h3>¬øPara qu√© sirve este estudio? ¬øQu√© ventajas tiene participar?</h3>
      <p class="muted">
        La informaci√≥n recopilada en este estudio es fundamental para que el Ayuntamiento de Orea pueda tomar decisiones
        basadas en datos reales y defender mejor los intereses del municipio.
      </p>
      <ul class="muted" style="padding-left:18px">
        <li><b>Dise√±ar pol√≠ticas municipales de vivienda ajustadas a la realidad</b>: ayudas al alquiler, rehabilitaci√≥n, intermediaci√≥n municipal y uso de vivienda vac√≠a.</li>
        <li><b>Acceder y justificar subvenciones y fondos europeos</b> (Next Generation, programas estatales y auton√≥micos), que exigen diagn√≥sticos previos y datos contrastados.</li>
        <li><b>Facilitar el contacto entre propietarios y personas interesadas</b> en comprar o alquilar en Orea, siempre con consentimiento expreso.</li>
        <li><b>Impulsar la rehabilitaci√≥n de viviendas</b> y la puesta en uso de inmuebles actualmente vac√≠os o infrautilizados.</li>
        <li><b>Planificar servicios municipales</b> (agua, residuos, infraestructuras, servicios sociales) en funci√≥n de la poblaci√≥n real y potencial.</li>
        <li><b>Combatir la despoblaci√≥n</b> y favorecer la llegada de nuevos vecinos y proyectos econ√≥micos al municipio.</li>
      </ul>
      <p class="muted" style="margin-top:10px">
        Tu colaboraci√≥n, aunque no tengas un inmueble disponible, es clave para disponer de una fotograf√≠a real de la situaci√≥n de la vivienda en Orea.
      </p>
    </div>
  </section>

  <section id="encuesta" class="section">
    <div class="card pad">
      <h3>Encuesta</h3>
      <p class="muted">Campos con * son obligatorios. El contacto es opcional (solo si quieres que se te pueda llamar o escribir).</p>

      <div class="msg ok" id="msgOk" role="status" aria-live="polite"></div>
      <div class="msg err" id="msgErr" role="alert"></div>

      <form id="formVivienda" novalidate>

        <fieldset>
          <legend>1) Perfil</legend>
          <div class="row">
            <div>
              <label for="vinculo">Tu relaci√≥n con Orea *</label>
              <select id="vinculo" name="vinculo" required>
                <option value="">Selecciona‚Ä¶</option>
                <option>Residente todo el a√±o</option>
                <option>Residente por temporadas</option>
                <option>Propietario/a</option>
                <option>Me gustar√≠a vivir en Orea</option>
                <option>Trabajo en Orea o alrededores</option>
                <option>Otro</option>
              </select>
            </div>
            <div>
              <label for="edad">Rango de edad *</label>
              <select id="edad" name="edad" required>
                <option value="">Selecciona‚Ä¶</option>
                <option>Menos de 18</option>
                <option>18‚Äì25</option>
                <option>26‚Äì35</option>
                <option>36‚Äì50</option>
                <option>51‚Äì65</option>
                <option>M√°s de 65</option>
                <option>Prefiero no decirlo</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
      <div>
        <label>Estado del inmueble</label>
        <select data-field="estado">
          <option value="">Selecciona‚Ä¶</option>
          <option>Bueno (sin reformas importantes)</option>
          <option>Aceptable (mejoras menores)</option>
          <option>Necesita rehabilitaci√≥n media</option>
          <option>Necesita rehabilitaci√≥n integral</option>
          <option>No lo s√©</option>
        </select>
      </div>
      <div>
        <label>Procedencia del inmueble (opcional)</label>
        <select data-field="procedencia">
          <option value="">Selecciona‚Ä¶</option>
          <option>Compra-venta</option>
          <option>Herencia</option>
          <option>Donaci√≥n</option>
          <option>Usufructo</option>
          <option>Proindiviso</option>
          <option>Otro</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <div>
        <label>Metros cuadrados aprox. (opcional)</label>
        <input data-field="m2" inputmode="numeric" placeholder="Ej.: 90" />
      </div>
      <div></div>
    </div>
        </fieldset>

        <fieldset>
          <legend>2) Si eres propietario/a: inmuebles (puedes a√±adir varios o colaborar sin disponibilidad)</legend>
          <p class="muted" style="margin-top:0">
            A√±ade aqu√≠ cada inmueble (vivienda, nave, negocio/local o parcela). En el caso de viviendas, necesitamos la direcci√≥n exacta.
            Si actualmente <b>no tienes el inmueble disponible</b> para vender o alquilar, puedes indicarlo igualmente como colaboraci√≥n con el estudio.
          </p>

          <div class="propList" id="propList"></div>

          <div class="cta" style="margin-top:10px">
            <button class="btn" type="button" id="btnAddProp">Ôºã A√±adir inmueble</button>
            <span class="hint">Puedes incluir varios (viviendas, naves, negocios/locales y parcelas).</span>
          </div>

          <div class="divider"></div>

          <div>
            <label for="propNotas">Notas (opcional)</label>
            <textarea id="propNotas" name="propNotas" placeholder="Ej.: necesita reforma, estar√≠a dispuesto a intermediaci√≥n municipal, disponibilidad por meses, etc."></textarea>
          </div>
        </fieldset>

        <fieldset>
          <legend>3) Si buscas vivienda/inmueble en Orea (demanda)</legend>
          <div class="row">
            <div>
              <label for="buscaQue">¬øQu√© te interesa? *</label>
              <select id="buscaQue" name="buscaQue" required>
                <option value="">Selecciona‚Ä¶</option>
                <option>Comprar vivienda</option>
                <option>Alquilar vivienda (anual)</option>
                <option>Alquilar vivienda (temporadas)</option>
                <option>Comprar parcela</option>
                <option>Alquilar o comprar nave</option>
                <option>Alquilar o comprar negocio/local</option>
                <option>No busco ahora mismo</option>
              </select>
            </div>
            <div>
              <label for="plazo">Plazo aproximado</label>
              <select id="plazo" name="plazo">
                <option value="">Selecciona‚Ä¶</option>
                <option>Inmediato (0‚Äì3 meses)</option>
                <option>Este a√±o</option>
                <option>1‚Äì2 a√±os</option>
                <option>M√°s de 2 a√±os</option>
                <option>No lo s√©</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <div>
              <label for="presupuestoCompra">Presupuesto m√°ximo de compra (si aplica)</label>
              <input id="presupuestoCompra" name="presupuestoCompra" inputmode="numeric" placeholder="Ej.: 120000" />
            </div>
            <div>
              <label for="presupuestoAlquiler">Presupuesto m√°ximo de alquiler mensual (si aplica)</label>
              <input id="presupuestoAlquiler" name="presupuestoAlquiler" inputmode="numeric" placeholder="Ej.: 450" />
            </div>
          </div>

          <div style="margin-top:12px">
            <label for="demandaNotas">Preferencias o condiciones (opcional)</label>
            <textarea id="demandaNotas" name="demandaNotas" placeholder="Ej.: tama√±o, n¬∫ habitaciones, condiciones, meses, etc."></textarea>
          </div>
        </fieldset>

        <fieldset>
          <legend>4) Contacto y consentimiento (opcional)</legend>
          <p class="muted" style="margin-top:0">
            Si quieres que el Ayuntamiento te contacte (por oferta o demanda), deja tus datos y marca el consentimiento.
          </p>

          <div class="row">
            <div>
              <label for="nombre">Nombre</label>
              <input id="nombre" name="nombre" placeholder="(opcional)" autocomplete="name" />
            </div>
            <div>
              <label for="telefono">Tel√©fono</label>
              <input id="telefono" name="telefono" placeholder="(opcional)" autocomplete="tel" />
            </div>
          </div>
          <div style="margin-top:12px">
            <label for="email">Email</label>
            <input id="email" name="email" placeholder="(opcional)" autocomplete="email" />
          </div>

          <div class="check" style="margin-top:12px">
            <input type="checkbox" id="consentContacto" name="consentContacto" value="s√≠" />
            <div>
              <label for="consentContacto" style="margin:0">Autorizo a usar mis datos de contacto para este estudio</label>
              <p>Para ampliaci√≥n de informaci√≥n y, si procede, para ponerme en relaci√≥n con oferta o demanda.</p>
            </div>
          </div>
        </fieldset>

        <fieldset>
          <legend>5) Consentimiento de participaci√≥n</legend>
          <div class="check">
            <input type="checkbox" id="consent" required />
            <div>
              <label for="consent" style="margin:0">He le√≠do el aviso de privacidad y acepto participar *</label>
              <p>Incluye el tratamiento de datos y, en su caso, direcci√≥n exacta del inmueble.</p>
            </div>
          </div>
        </fieldset>

        <div class="cta">
          <button class="btn btnPrimary" type="submit">‚úÖ Guardar respuesta</button>
          <button class="btn" type="button" id="btnVer">üëÅÔ∏è Ver datos guardados</button>
          <button class="btn btnDanger" type="button" id="btnBorrar">üóëÔ∏è Borrar mis respuestas</button>
        </div>

      </form>

      <div id="vistaDatos" class="card" style="display:none;margin-top:14px">
        <div class="pad">
          <h3 style="margin-top:0">Datos guardados (en este dispositivo)</h3>
          <p class="muted">Puedes copiar/pegar esto en el email si lo necesitas.</p>
          <pre id="preDatos" style="white-space:pre-wrap;word-wrap:break-word;background:#f8fafc;border:1px solid var(--line);padding:12px;border-radius:12px;margin:0"></pre>
        </div>
      </div>

    </div>
  </section>

  <section id="privacidad" class="section">
    <div class="card pad">
      <h3>Aviso de privacidad (resumen)</h3>
      <p class="muted">
        Este formulario se utiliza exclusivamente para un estudio municipal sobre la vivienda en Orea.
        La participaci√≥n es voluntaria y el contacto es opcional.
      </p>
      <ul class="muted" style="margin:0;padding-left:18px">
        <li>Los datos se usar√°n √∫nicamente para conocer la situaci√≥n de la vivienda y facilitar, si se consiente, la conexi√≥n entre oferta y demanda.</li>
        <li>En el caso de inmuebles, se solicita la direcci√≥n exacta para an√°lisis interno.</li>
        <li>No se solicitan ni deben facilitarse datos especialmente protegidos.</li>
        <li>La recogida de datos estar√° abierta hasta el <b>31 de enero de 2026</b>.</li>
      </ul>
      <p class="muted" style="margin-top:10px">
        La informaci√≥n completa sobre protecci√≥n de datos puede consultarse en la pesta√±a RGPD.
      </p>
    </div>
  </section>

  <section id="rgpd" class="section">
    <div class="card pad">
      <h3>Informaci√≥n sobre protecci√≥n de datos (RGPD)</h3>
      <p class="muted"><b>Responsable del tratamiento:</b> Ayuntamiento de Orea.</p>
      <p class="muted"><b>Finalidad del tratamiento:</b> Recopilar informaci√≥n para conocer la situaci√≥n actual de la vivienda en el municipio de Orea y, en su caso, facilitar la conexi√≥n entre personas ofertantes y demandantes de vivienda u otros inmuebles.</p>
      <p class="muted"><b>Base jur√≠dica:</b></p>
      <ul class="muted" style="padding-left:18px">
        <li>Art√≠culo 6.1.a del Reglamento (UE) 2016/679 (consentimiento de la persona interesada).</li>
        <li>Art√≠culo 6.1.e del Reglamento (UE) 2016/679 (misi√≥n realizada en inter√©s p√∫blico).</li>
        <li>Ley Org√°nica 3/2018, de 5 de diciembre, de Protecci√≥n de Datos Personales y garant√≠a de los derechos digitales.</li>
      </ul>
      <p class="muted"><b>Personas destinatarias:</b> No se ceder√°n datos a terceros, salvo obligaci√≥n legal. Los datos podr√°n utilizarse internamente por el Ayuntamiento de Orea para los fines descritos.</p>
      <p class="muted"><b>Plazo de conservaci√≥n:</b> Los datos se conservar√°n durante el tiempo necesario para la realizaci√≥n del estudio y, como m√°ximo, hasta la finalizaci√≥n de las actuaciones municipales derivadas del mismo.</p>
      <p class="muted"><b>Derechos:</b> Las personas interesadas pueden ejercer los derechos de acceso, rectificaci√≥n, supresi√≥n, oposici√≥n, limitaci√≥n del tratamiento y portabilidad mediante solicitud dirigida al Ayuntamiento de Orea.</p>
      <p class="muted"><b>Informaci√≥n adicional:</b> En caso de disconformidad, se podr√° presentar reclamaci√≥n ante la Agencia Espa√±ola de Protecci√≥n de Datos (www.aepd.es).</p>
    </div>
  </section>

  <section id="contacto" class="section">
    <div class="card pad">
      <h3>Contacto</h3>
      <p class="muted">Email del estudio (correo del alcalde, responsable del estudio): <b>rcalvo.orea@gmail.com</b></p>
    </div>
  </section>

</main>

<footer>
  <div class="container">
    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between">
      <div>¬© <span id="year"></span> Ayuntamiento de Orea ¬∑ Estudio de Vivienda</div>
      
    </div>
  </div>
</footer>

<template id="tplProp">
  <div class="propItem" data-prop>
    <div class="propHead">
      <b>Inmueble <span data-prop-num></span></b>
      <button class="btn btnDanger" type="button" data-remove>Eliminar</button>
    </div>

    <div class="row">
      <div>
        <label>Tipo de inmueble *</label>
        <select data-field="tipo" required>
          <option value="">Selecciona‚Ä¶</option>
          <option>Vivienda</option>
          <option>Nave</option>
          <option>Negocio / local</option>
          <option>Parcela</option>
        </select>
      </div>
      <div>
        <label>Uso actual</label>
        <select data-field="uso">
          <option value="">Selecciona‚Ä¶</option>
          <option>Vivienda habitual</option>
          <option>Segunda residencia</option>
          <option>Vac√≠o / en desuso</option>
          <option>En alquiler</option>
          <option>En venta</option>
          <option>No aplica</option>
        </select>
      </div>
    </div>

    <div style="margin-top:12px">
      <label>Direcci√≥n exacta *</label>
      <input data-field="direccion" required placeholder="Ej.: Calle X, n¬∫ Y (Orea)" />
    </div>

    <div class="row" style="margin-top:12px">
      <div>
        <label>Estado del inmueble</label>
        <select data-field="estado">
          <option value="">Selecciona‚Ä¶</option>
          <option>Bueno (sin reformas importantes)</option>
          <option>Aceptable (mejoras menores)</option>
          <option>Necesita rehabilitaci√≥n media</option>
          <option>Necesita rehabilitaci√≥n integral</option>
          <option>No lo s√©</option>
        </select>
      </div>
      <div>
        <label>Metros cuadrados aprox. (opcional)</label>
        <input data-field="m2" inputmode="numeric" placeholder="Ej.: 90" />
      </div>
    </div>

    <div class="divider"></div>

    <p class="muted" style="margin:0 0 8px"><b>Disponibilidad (puedes marcar ninguna opci√≥n si no est√° disponible)</b></p>

    <div class="row">
      <div class="check">
        <input type="checkbox" data-field="op_vender" />
        <div>
          <label style="margin:0">Vender</label>
          <p>Indica precio orientativo si te interesa.</p>
        </div>
      </div>
      <div>
        <label>Precio de venta (euros)</label>
        <input data-field="precio_venta" inputmode="numeric" placeholder="Ej.: 85000" />
      </div>
    </div>

    <div class="row">
      <div class="check">
        <input type="checkbox" data-field="op_alquilar_anual" />
        <div>
          <label style="margin:0">Alquilar (anual)</label>
          <p>Indica renta orientativa mensual.</p>
        </div>
      </div>
      <div>
        <label>Alquiler anual (euros/mes)</label>
        <input data-field="precio_alq_anual" inputmode="numeric" placeholder="Ej.: 400" />
      </div>
    </div>

    <div class="row">
      <div class="check">
        <input type="checkbox" data-field="op_alquilar_temporadas" />
        <div>
          <label style="margin:0">Alquilar (temporadas)</label>
          <p>Indica precio orientativo o comenta abajo.</p>
        </div>
      </div>
      <div>
        <label>Alquiler temporadas (euros/mes aprox.)</label>
        <input data-field="precio_alq_temp" inputmode="numeric" placeholder="Ej.: 650" />
      </div>
    </div>

    <div style="margin-top:12px">
      <label>Observaciones (opcional)</label>
      <textarea data-field="obs" placeholder="Ej.: meses disponibles, condiciones, etc."></textarea>
    </div>
  </div>
</template>

<script>
  const STORAGE_KEY = "orea_estudio_vivienda_v2";
  const EMAIL_TO = "rcalvo.orea@gmail.com";
  const NL = String.fromCharCode(10);

  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));
  const show = (el) => { el.style.display = "block"; };
  const hide = (el) => { el.style.display = "none"; };

  function setMsg(kind, text){
    const ok = $("#msgOk");
    const err = $("#msgErr");
    hide(ok); hide(err);
    if(!text) return;
    const el = kind === "ok" ? ok : err;
    el.textContent = text;
    el.classList.remove("ok","err");
    el.classList.add(kind);
    show(el);
    el.scrollIntoView({behavior:"smooth", block:"start"});
  }

  function nowISO(){ return new Date().toISOString(); }

  function validateEmailSimple(email){
    if(!email) return true;
    const s = String(email).trim();
    const at = s.indexOf("@");
    if(at <= 0) return false;
    const dot = s.indexOf(".", at + 2);
    return dot > at + 1 && dot < s.length - 1;
  }

  function toIntOrNull(v){
    if(v === undefined || v === null) return null;
    const s = String(v).trim();
    if(!s) return null;
    const n = Number(s);
    return Number.isFinite(n) ? Math.round(n) : null;
  }

  function loadSaved(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return null;
      return JSON.parse(raw);
    }catch(e){
      return null;
    }
  }

  function saveData(payload){ localStorage.setItem(STORAGE_KEY, JSON.stringify(payload, null, 2)); }
  function clearData(){ localStorage.removeItem(STORAGE_KEY); }

  function downloadJSON(filename, obj){
    const blob = new Blob([JSON.stringify(obj, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function renumberProps(){
    $$("[data-prop]").forEach((el, idx) => {
      const num = el.querySelector("[data-prop-num]");
      if(num) num.textContent = String(idx + 1);
    });
  }

  function addProp(prefill){
    const tpl = $("#tplProp");
    const node = tpl.content.firstElementChild.cloneNode(true);

    node.querySelector("[data-remove]").addEventListener("click", () => {
      node.remove();
      renumberProps();
    });

    if(prefill){
      Object.entries(prefill).forEach(([k,v]) => {
        const field = node.querySelector(`[data-field="${k}"]`);
        if(!field) return;
        if(field.type === "checkbox") field.checked = !!v;
        else field.value = v ?? "";
      });
    }

    $("#propList").appendChild(node);
    renumberProps();
  }

  function readProps(){
    const items = [];
    $$("[data-prop]").forEach(el => {
      const get = (k) => {
        const f = el.querySelector(`[data-field="${k}"]`);
        if(!f) return null;
        if(f.type === "checkbox") return !!f.checked;
        return String(f.value || "").trim();
      };

      const obj = {
        tipo: get("tipo"),
        uso: get("uso"),
        direccion: get("direccion"),
        estado: get("estado"),
        procedencia: get("procedencia"),
        m2: toIntOrNull(get("m2")),
        op_vender: get("op_vender"),
        precio_venta: toIntOrNull(get("precio_venta")),
        op_alquilar_anual: get("op_alquilar_anual"),
        precio_alq_anual: toIntOrNull(get("precio_alq_anual")),
        op_alquilar_temporadas: get("op_alquilar_temporadas"),
        precio_alq_temp: toIntOrNull(get("precio_alq_temp")),
        obs: get("obs")
      };

      const any = Object.values(obj).some(v => v && v !== false);
      if(any) items.push(obj);
    });
    return items;
  }

  function formToObject(form){
    const fd = new FormData(form);
    const data = {};
    for (const [k, v] of fd.entries()) data[k] = (typeof v === "string") ? v.trim() : v;

    data.consentContacto = fd.get("consentContacto") === "s√≠";
    data.presupuestoCompra = toIntOrNull(data.presupuestoCompra);
    data.presupuestoAlquiler = toIntOrNull(data.presupuestoAlquiler);
    data.inmuebles = readProps();

    return data;
  }

  function populateForm(saved){
    if(!saved || !saved.respuesta) return;
    const r = saved.respuesta;

    ["vinculo","edad","hogar","trabajo","buscaQue","plazo","presupuestoCompra","presupuestoAlquiler","demandaNotas","propNotas","nombre","telefono","email"].forEach(id => {
      const el = document.getElementById(id);
      if(!el) return;
      if(r[id] !== undefined && r[id] !== null) el.value = r[id];
    });

    const cc = document.getElementById("consentContacto");
    if(cc) cc.checked = !!r.consentContacto;

    (r.inmuebles || []).forEach(p => addProp(p));
    if((r.inmuebles || []).length === 0) addProp();
  }

  function buildEmailBody(payload){
    const r = payload.respuesta;
    const lines = [];
    lines.push("ESTUDIO DE VIVIENDA ¬∑ OREA");
    lines.push("Fecha (ISO): " + payload.actualizado_en);
    lines.push("‚Äî");
    lines.push("Perfil: " + (r.vinculo || "") + " | Edad: " + (r.edad || "") + " | Hogar: " + (r.hogar || ""));
    lines.push("‚Äî");
    lines.push("Demanda: " + (r.buscaQue || ""));
    if(r.plazo) lines.push("Plazo: " + r.plazo);
    if(r.presupuestoCompra != null) lines.push("Presupuesto compra: " + r.presupuestoCompra + " euros");
    if(r.presupuestoAlquiler != null) lines.push("Presupuesto alquiler: " + r.presupuestoAlquiler + " euros/mes");
    if(r.demandaNotas) lines.push("Notas demanda: " + r.demandaNotas);
    lines.push("‚Äî");
    lines.push("Inmuebles: " + (r.inmuebles ? r.inmuebles.length : 0));
    (r.inmuebles || []).forEach((p, i) => {
      lines.push("[" + (i+1) + "] " + (p.tipo || "") + " - " + (p.direccion || "") + (p.procedencia ? " | Procedencia: " + p.procedencia : ""));
      if(p.op_vender) lines.push("  Vender: si | Precio: " + (p.precio_venta ?? ""));
      if(p.op_alquilar_anual) lines.push("  Alquilar anual: si | Precio: " + (p.precio_alq_anual ?? ""));
      if(p.op_alquilar_temporadas) lines.push("  Alquilar temporadas: si | Precio: " + (p.precio_alq_temp ?? ""));
      if(p.obs) lines.push("  Obs: " + p.obs);
    });
    if(r.propNotas) lines.push("Notas inmuebles: " + r.propNotas);
    lines.push("‚Äî");
    lines.push("Contacto: " + (r.nombre || "") + " | " + (r.telefono || "") + " | " + (r.email || ""));
    lines.push("Consentimiento contacto: " + (r.consentContacto ? "si" : "no"));
    lines.push("‚Äî");
    lines.push("JSON: " + JSON.stringify(payload));
    return lines.join(NL);
  }

  function openMailDraft(){
    const saved = loadSaved();
    if(!saved){ setMsg("err", "No hay datos guardados para enviar. Primero guarda la encuesta."); return; }
    const subject = encodeURIComponent("Estudio vivienda Orea ¬∑ Respuesta");
    const body = encodeURIComponent(buildEmailBody(saved));
    const url = "mailto:" + encodeURIComponent(EMAIL_TO) + "?subject=" + subject + "&body=" + body;
    if(url.length > 1800){
      setMsg("err", "El email puede salir demasiado largo (muchos inmuebles). Descarga el JSON y adj√∫ntalo en el email.");
    }
    window.location.href = url;
  }

  (function init(){
    $("#year").textContent = String(new Date().getFullYear());
    const saved = loadSaved();
    if(saved) populateForm(saved);
    else addProp();
  })();

  $("#btnAddProp").addEventListener("click", () => addProp());

  $("#formVivienda").addEventListener("submit", (e) => {
    e.preventDefault();
    setMsg("ok", "");

    const form = e.currentTarget;

    if(!form.checkValidity()){
      setMsg("err", "Revisa los campos obligatorios marcados con *.");
      form.reportValidity();
      return;
    }

    if(!$("#consent").checked){
      setMsg("err", "Necesitas aceptar el aviso de privacidad para participar.");
      $("#consent").focus();
      return;
    }

    const obj = formToObject(form);

    if(obj.email && !validateEmailSimple(obj.email)){
      setMsg("err", "El email no parece v√°lido.");
      $("#email").focus();
      return;
    }

    if((obj.email || obj.telefono) && !obj.consentContacto){
      setMsg("err", "Has dejado datos de contacto, pero no has marcado el consentimiento de uso del contacto. M√°rcalo o borra el contacto.");
      $("#consentContacto").focus();
      return;
    }

    const payload = { version: 2, actualizado_en: nowISO(), respuesta: obj };
    saveData(payload);
    setMsg("ok", "Guardado. Ahora puedes pulsar ‚ÄúEnviar por email‚Äù para mandar la respuesta.");
  });

  $("#btnVer").addEventListener("click", () => {
    const saved = loadSaved();
    if(!saved){ setMsg("err", "No hay datos guardados en este dispositivo."); hide($("#vistaDatos")); return; }
    $("#preDatos").textContent = JSON.stringify(saved, null, 2);
    show($("#vistaDatos"));
    $("#vistaDatos").scrollIntoView({behavior:"smooth", block:"start"});
  });

  $("#btnBorrar").addEventListener("click", () => {
    clearData();
    $("#formVivienda").reset();
    $("#propList").innerHTML = "";
    addProp();
    hide($("#vistaDatos"));
    setMsg("ok", "Se han borrado tus respuestas guardadas en este dispositivo.");
  });

  $("#btnDescargar").addEventListener("click", () => {
    const saved = loadSaved();
    if(!saved){ setMsg("err", "No hay datos guardados para descargar. Primero guarda la encuesta."); return; }
    downloadJSON("orea_estudio_vivienda.json", saved);
  });

  $("#btnEnviar").addEventListener("click", () => openMailDraft());
</script>

</body>
</html>
